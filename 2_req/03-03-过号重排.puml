@startuml
title Activity Diagram: BUC06 处理过号重排
' 设置样式
skinparam backgroundColor white
skinparam activity {
  BackgroundColor<<System>> #E6F7FF
  BorderColor<<System>> #1890FF
  BackgroundColor #White
  BorderColor #333333
  ArrowColor #333333
}

' 定义泳道
|#F0FFF0|Nurse| 护士
|#E6F7FF|System| 智能候诊系统
|#F0F0F0|Student| 学生
|#F0F0F0|Doctor| 医生

' 开始流程
|Nurse|
start
:输入学生姓名或扫描挂号单;

|System|
:查询数据库;
:返回学生详情及当前状态;

|Nurse|
:点击 "过号重排(激活)" 按钮;

|System|
if (当前状态 == '过号'?) then (否)
    :提示 "该学生当前状态不可重排";
    note right
        只有状态为 Missed
        才能执行此操作
    end note
    stop
else (是)
    :检查今日累计重排次数;
endif

if (重排次数 >= 上限(如3次)?) then (是)
    :提示 "重排次数超限，请重新挂号";
    stop
else (否)
    partition "顺延插入算法" {
        :获取当前正在叫号/就诊的位置索引 (Idx_Current);
        
        :计算目标位置 Target = Idx_Current + 3;
        note right
            **关键业务规则：**
            顺延3位策略
            (若队列长度不足，则插队尾)
        end note
        
        :将学生节点插入到队列 Target 位置;
        :更新学生状态: "过号" -> "候诊中";
        :今日重排次数计数器 +1;
    }
endif

' 并行反馈结果
fork
    |Nurse|
    :弹窗提示 "重排成功";
    :分诊台列表显示学生已归队;
    
fork again
    |Student|
    :手机收到 "排队恢复通知";
    :刷新查看新的预计等待时间;
    
fork again
    |System|
    :触发队列更新事件;
    
    |Doctor|
    :待诊列表自动刷新;
    note right
        医生可能会看到
        待诊名单中突然插入一人
    end note
end fork

stop
@enduml