@startuml
' --- 布局设置 ---
top to bottom direction
' 增加节点间距，防止线条过于密集
skinparam nodesep 60
skinparam ranksep 60

' --- Rose 风格配色 ---
skinparam class {
    BackgroundColor #FEFECE
    ArrowColor #A80036
    BorderColor #A80036
    AttributeFontName Arial
    AttributeFontSize 11
}
skinparam package {
    BackgroundColor #FFFFFF
    BorderColor #000000
    FontName Arial
}

' ==========================================
' 1. Domain Layer (领域模型层 - 核心实体)
' ==========================================
package "领域模型层 (Domain Model)" {

    class "设备 (Device)" as Device {
        - 设备ID : String
        - 设备名称 : String
        - 在线状态 : Enum {在线, 离线, 告警}
        - 固件版本 : String
        - 证书ID : String
        .. 需求追踪 ..
        [UC01 注册接入]
        [UC03 监控状态]
        [UC07 退役报废]
    }

    class "空间 (Space)" as Space {
        - 空间ID : String
        - 空间名称 : String
        - 空间类型 : Enum {楼宇, 楼层, 房间}
        .. 需求追踪 ..
        [UC02 构建拓扑]
        [UC04 智能查询]
    }

    class "固件包 (FirmwarePackage)" as Firmware {
        - 版本号 : String
        - 下载地址 : URL
        - MD5校验码 : String
        - 发布时间 : DateTime
        .. 需求追踪 ..
        [UC06 固件管理]
    }

    class "安全告警 (SecurityAlert)" as Alert {
        - 告警ID : String
        - 告警级别 : Enum {低, 中, 高}
        - 发生时间 : DateTime
        - 原始报文 : String
        .. 需求追踪 ..
        [UC08 安全告警]
    }

    ' --- 继承关系 ---
    class "网关 (Gateway)" as Gateway {
        - 最大挂载数 : Integer
        - 协议类型 : String
    }
    
    class "传感器 (Sensor)" as Sensor {
        - 采集精度 : Float
        - 数据单位 : String
    }

    Device <|-- Gateway
    Device <|-- Sensor

    ' --- 关联关系 ---
    ' 1. 空间自关联（组合）：楼宇包含房间
    Space "1 (父)" *-- "0..* (子)" Space : 包含 >

    ' 2. 设备位于空间（聚合）：设备可以移动，不强属于空间
    Space "1" o-- "0..*" Device : 位于 >

    ' 3. 设备连接网关（关联）：传感器连接网关
    Gateway "1" -- "0..*" Sensor : 管理连接 >

    ' 4. 设备包含固件信息
    Device "0..*" --> "0..1" Firmware : 安装 >

    ' 5. 设备产生告警
    Device "1" -- "0..*" Alert : 触发 >
}

' ==========================================
' 2. Application Layer (应用服务层 - 业务逻辑)
' ==========================================
package "应用服务层 (Application Services)" {

    class "拓扑服务 (TopologyService)" as TopologySvc {
        + 绑定空间关系(deviceId, spaceId)
        + 构建网络关联(sensorId, gatewayId)
        + 获取影响范围(deviceId) : List<Device>
        .. 需求追踪 ..
        [UC-02 构建拓扑]
    }

    class "智能体服务 (AgentService)" as AgentSvc {
        + 解析自然语言(question) : Cypher
        + 生成分析报告(graphData) : String
        .. 需求追踪 ..
        [UC-04 智能查询]
    }

    class "生命周期服务 (LifecycleService)" as LifeSvc {
        + 注册设备(metaData)
        + 灰度升级固件(version, deviceIds)
        + 退役设备(deviceId)
        .. 需求追踪 ..
        [UC-01, UC-06, UC-07]
    }

    class "指令控制服务 (ControlService)" as ControlSvc {
        + 下发指令(deviceId, command)
        + 批量重启(deviceIds)
        .. 需求追踪 ..
        [UC-05 远程指令]
    }
}

' ==========================================
' 3. Infrastructure Layer (基础设施层 - 接口定义)
' ==========================================
package "基础设施接口 (Infrastructure Interfaces)" {

    interface "图数据库仓库 (GraphRepository)" as GraphRepo {
        + executeCypher(query)
        + mergeNode(label, props)
        + deleteRelationship(from, to)
        .. 需求追踪 ..
        [UC-02, UC-04, UC-07]
    }

    interface "大模型客户端 (LLMClient)" as LLMClient {
        + chatCompletion(prompt)
        .. 需求追踪 ..
        [UC-04 智能查询]
    }

    interface "IoT连接器 (IoTConnector)" as IoTConn {
        + sendMqttMessage(topic, payload)
        + revokeCertificate(certId)
        .. 需求追踪 ..
        [UC-01, UC-05, UC-07]
    }
}

' ==========================================
' 跨层依赖关系 (Dependency)
' ==========================================

' 服务层依赖领域实体 (使用)
TopologySvc ..> Space : 维护
TopologySvc ..> Device : 维护
LifeSvc ..> Device : 管理
LifeSvc ..> Firmware : 发布
AgentSvc ..> Device : 查询

' 服务层依赖基础设施接口 (调用)
TopologySvc ..> GraphRepo : 存取图谱
AgentSvc ..> GraphRepo : 查询图谱
AgentSvc ..> LLMClient : 语义分析
LifeSvc ..> IoTConn : 设备交互
ControlSvc ..> IoTConn : 指令下发

@enduml