这是基于之前的架构设计（包图）和业务流程（活动图）绘制的 **PlantUML 序列图**。

这些图表严格遵循了以下原则：
1.  **分层调用原则**：Actor -> UI -> Application Service -> Infrastructure -> Domain/DB。
2.  **Rose 配色风格**：黄色对象、红色线条。
3.  **完整组件**：包含生命线、激活条（Activation Bar）、返回消息（Dashed Arrow）以及关键的组合片段（Alt/Loop）。

---

### 1. UC-02 维护图谱拓扑 (Maintain Graph Topology)

**核心逻辑**：
该序列图展示了典型的 **OLTP（联机事务处理）** 流程。重点在于 `TopologyService` 如何充当协调者，先校验业务规则（领域逻辑），再调用 `GraphAdapter` 执行具体的 Cypher 语句（基础设施逻辑）。

```plantuml
@startuml
title UC-02 维护图谱拓扑序列图
autonumber
skinparam sequence {
    LifeLineBorderColor #A80036
    LifeLineBackgroundColor #FEFECE
    ParticipantBorderColor #A80036
    ParticipantBackgroundColor #FEFECE
    ActorBorderColor #A80036
    ActorBackgroundColor #FEFECE
    ArrowColor #A80036
    BoxBorderColor #A80036
    BoxBackgroundColor #FFFFFF
}

actor "运维工程师" as User
participant ":Web管理门户" as UI
participant ":TopologyService" as Service
participant ":Device" as DeviceEntity
participant ":GraphAdapter\n(Neo4j)" as DB

activate User

User -> UI : 提交拓扑配置\n(deviceId, roomId, gatewayId)
activate UI

UI -> Service : bindTopology(cmd)
activate Service

' --- 步骤1：业务校验 ---
Service -> Service : validateLogic()
activate Service #DarkSalmon
    note right: 校验网关容量、\n房间是否存在
deactivate Service

alt 校验失败
    Service --> UI : throw ValidationException
    UI --> User : 显示错误提示
else 校验通过
    ' --- 步骤2：实体状态更新 ---
    Service -> DeviceEntity : updateLocation(roomId)
    activate DeviceEntity
    DeviceEntity --> Service : ok
    deactivate DeviceEntity

    ' --- 步骤3：构建Cypher并执行 ---
    Service -> Service : buildMergeCypher()
    
    Service -> DB : execute(cypherStmt)
    activate DB
    note right of DB
        MERGE (d)-[:LOCATED_IN]->(r)
        MERGE (d)-[:CONNECTED_TO]->(g)
    end note
    
    DB --> Service : result(nodesCreated, relsCreated)
    deactivate DB

    Service --> UI : return SuccessDTO
end

deactivate Service

UI --> User : 显示"拓扑关系已建立"
deactivate UI
deactivate User
@enduml
```

---

### 2. UC-04 智能问答诊断 (Intelligent QA Diagnosis)

**核心逻辑**：
这是一个典型的 **RAG (Retrieval-Augmented Generation)** 流程。
1.  **Text-to-Cypher**：先找 LLM 要查询语句。
2.  **Graph Query**：拿着语句去查图数据库。
3.  **Summarization**：把查到的数据扔回给 LLM 做总结。

```plantuml
@startuml
title UC-04 智能问答诊断序列图
autonumber
skinparam sequence {
    LifeLineBorderColor #A80036
    LifeLineBackgroundColor #FEFECE
    ParticipantBorderColor #A80036
    ParticipantBackgroundColor #FEFECE
    ActorBorderColor #A80036
    ActorBackgroundColor #FEFECE
    ArrowColor #A80036
}

actor "运营经理" as User
participant ":ChatInterface" as UI
participant ":AgentService" as Agent
participant ":LLMGateway" as LLM
participant ":GraphAdapter\n(Neo4j)" as DB

activate User

User -> UI : 输入自然语言问题\n"A栋温度异常的传感器有哪些？"
activate UI

UI -> Agent : ask(question)
activate Agent

' --- 阶段1：意图识别与SQL生成 ---
Agent -> LLM : complete(prompt + schema + question)
activate LLM
note right: Prompt工程：\n"你是图谱专家，请将问题转换为Cypher..."
LLM --> Agent : return "MATCH (s:Sensor)..."
deactivate LLM

' --- 阶段2：执行图谱查询 ---
Agent -> Agent : sanitizeCypher(cypher)
note right: 安全过滤，防止注入

Agent -> DB : executeQuery(cypher)
activate DB
DB --> Agent : return GraphData (JSON)
deactivate DB

alt 查询结果为空
    Agent --> UI : return "未找到相关设备"
else 查询成功
    ' --- 阶段3：结果生成与可视化 ---
    Agent -> LLM : summarize(question, graphData)
    activate LLM
    LLM --> Agent : return "分析报告：发现3个异常..."
    deactivate LLM
    
    Agent --> UI : return Response(text, subGraphNodes)
end

deactivate Agent

UI -> UI : renderChatBubble(text)
UI -> UI : renderTopologyCanvas(subGraphNodes)
UI --> User : 展示回答与图谱
deactivate UI
deactivate User
@enduml
```

---

### 3. UC-07 退役报废设备 (Decommission Device)

**核心逻辑**：
展示了复杂的业务协同。
1.  **远程控制**：通过 MQTT 清除物理数据。
2.  **数据一致性**：物理清除成功后，才能清理图谱关系。
3.  **异常处理**：使用 `alt` 片段处理“设备离线”的强制退役场景。

```plantuml
@startuml
title UC-07 退役报废设备序列图
autonumber
skinparam sequence {
    LifeLineBorderColor #A80036
    LifeLineBackgroundColor #FEFECE
    ParticipantBorderColor #A80036
    ParticipantBackgroundColor #FEFECE
    ActorBorderColor #A80036
    ActorBackgroundColor #FEFECE
    ArrowColor #A80036
}

actor "运维工程师" as User
participant ":Web管理门户" as UI
participant ":LifecycleService" as Service
participant ":IoTConnector\n(MQTT)" as MQTT
participant ":GraphAdapter\n(Neo4j)" as DB

activate User

User -> UI : 请求退役设备(deviceId)
activate UI

UI -> Service : decommission(deviceId)
activate Service

' --- 步骤1：检查在线状态 ---
Service -> MQTT : checkStatus(deviceId)
activate MQTT
MQTT --> Service : isOnline
deactivate MQTT

alt 设备在线 (Happy Path)
    ' --- 步骤2：物理擦除 ---
    Service -> MQTT : sendCommand(WIPE_DATA)
    activate MQTT
    MQTT --> Service : ack
    deactivate MQTT
    
    loop 轮询直到完成 (Max 3 times)
        Service -> MQTT : getCommandResult()
        activate MQTT
        MQTT --> Service : status=COMPLETED
        deactivate MQTT
    end
else 设备离线 (Force Path)
    Service -> Service : logAudit("强制退役 - 无法物理擦除")
end

' --- 步骤3：逻辑清理 (无论在线离线都要做) ---
Service -> Service : revokeCertificate()

' --- 步骤4：图谱清理 ---
Service -> DB : executeTransaction()
activate DB
note right of DB
    1. MATCH (d)-[r]-() DELETE r
    2. SET d.status = 'RETIRED'
end note
DB --> Service : txCommitted
deactivate DB

Service --> UI : return Success
deactivate Service

UI --> User : 提示"设备已安全退役"
deactivate UI
deactivate User
@enduml
```

### 绘图细节说明（符合规范）：

1.  **对象命名规范**：
    *   UI层使用了 `WebPortal`, `ChatInterface`。
    *   服务层使用了 `Service` 结尾（如 `TopologyService`），对应包图中的 Application Layer。
    *   基础设施层使用了 `Adapter` 或 `Gateway` 结尾，体现了**依赖倒置**原则（应用层只依赖接口，不依赖具体实现）。

2.  **生命线与激活条**：
    *   每个对象（LifeLine）都有垂直虚线。
    *   每当收到消息（实线箭头）时，对应的生命线上会出现矩形条（激活条），表示该对象正在占用 CPU 处理任务。
    *   处理完毕返回时，使用虚线箭头（Reply Message），激活条结束。

3.  **组合片段 (Combined Fragments)**：
    *   **UC-02**: 使用 `alt` 处理校验失败的情况。
    *   **UC-04**: 使用 `alt` 处理查不到数据的情况。
    *   **UC-07**: 使用 `alt` 区分在线/离线流程，使用 `loop` 模拟等待设备响应的过程。

4.  **业务逻辑体现**：
    *   在序列图中不仅仅画了“存数据”，还画出了“生成Cypher”、“校验逻辑”、“Prompt工程”等具体动作，这正是我们在“阶段2”活动图里定义的内容。