这是一个基于前几个阶段（用例、包图、序列图）分析得出的**系统级类图**。

### 设计说明：
1.  **架构分层**：为了清晰展示，我将类分为了 **Domain (领域实体层)**、**Application (应用服务层)** 和 **Infrastructure (基础设施接口层)**。这符合包图的架构。
2.  **符号规范**：
    *   **实心菱形 (组合)**：用于“空间”结构（楼宇包含房间，楼宇没了房间也没了）。
    *   **空心三角 (泛化)**：用于设备类型的继承（传感器、网关都属于设备）。
    *   **虚线箭头 (依赖)**：服务层依赖接口层，或服务层依赖实体层。
3.  **需求追踪**：每个类内部底部的区域标注了该类主要支撑的 `[UC编号]`，满足你的追踪要求。
4.  **候选实体**：只列出了核心属性，隐藏了 Getter/Setter 和非核心方法，保持图面整洁。

---

### PlantUML 类图代码

```plantuml
@startuml
' --- 布局设置 ---
top to bottom direction
' 增加节点间距，防止线条过于密集
skinparam nodesep 60
skinparam ranksep 60

' --- Rose 风格配色 ---
skinparam class {
    BackgroundColor #FEFECE
    ArrowColor #A80036
    BorderColor #A80036
    AttributeFontName Arial
    AttributeFontSize 11
}
skinparam package {
    BackgroundColor #FFFFFF
    BorderColor #000000
    FontName Arial
}

' ==========================================
' 1. Domain Layer (领域模型层 - 核心实体)
' ==========================================
package "领域模型层 (Domain Model)" {

    class "设备 (Device)" as Device {
        - 设备ID : String
        - 设备名称 : String
        - 在线状态 : Enum {在线, 离线, 告警}
        - 固件版本 : String
        - 证书ID : String
        .. 需求追踪 ..
        [UC-01 注册接入]
        [UC-03 监控状态]
        [UC-07 退役报废]
    }

    class "空间 (Space)" as Space {
        - 空间ID : String
        - 空间名称 : String
        - 空间类型 : Enum {楼宇, 楼层, 房间}
        .. 需求追踪 ..
        [UC-02 构建拓扑]
        [UC-04 智能查询]
    }

    class "固件包 (FirmwarePackage)" as Firmware {
        - 版本号 : String
        - 下载地址 : URL
        - MD5校验码 : String
        - 发布时间 : DateTime
        .. 需求追踪 ..
        [UC-06 固件管理]
    }

    class "安全告警 (SecurityAlert)" as Alert {
        - 告警ID : String
        - 告警级别 : Enum {低, 中, 高}
        - 发生时间 : DateTime
        - 原始报文 : String
        .. 需求追踪 ..
        [UC-08 安全告警]
    }

    ' --- 继承关系 ---
    class "网关 (Gateway)" as Gateway {
        - 最大挂载数 : Integer
        - 协议类型 : String
    }
    
    class "传感器 (Sensor)" as Sensor {
        - 采集精度 : Float
        - 数据单位 : String
    }

    Device <|-- Gateway
    Device <|-- Sensor

    ' --- 关联关系 ---
    ' 1. 空间自关联（组合）：楼宇包含房间
    Space "1 (父)" *-- "0..* (子)" Space : 包含 >

    ' 2. 设备位于空间（聚合）：设备可以移动，不强属于空间
    Space "1" o-- "0..*" Device : 位于 >

    ' 3. 设备连接网关（关联）：传感器连接网关
    Gateway "1" -- "0..*" Sensor : 管理连接 >

    ' 4. 设备包含固件信息
    Device "0..*" --> "0..1" Firmware : 安装 >

    ' 5. 设备产生告警
    Device "1" -- "0..*" Alert : 触发 >
}

' ==========================================
' 2. Application Layer (应用服务层 - 业务逻辑)
' ==========================================
package "应用服务层 (Application Services)" {

    class "拓扑服务 (TopologyService)" as TopologySvc {
        + 绑定空间关系(deviceId, spaceId)
        + 构建网络关联(sensorId, gatewayId)
        + 获取影响范围(deviceId) : List<Device>
        .. 需求追踪 ..
        [UC-02 构建拓扑]
    }

    class "智能体服务 (AgentService)" as AgentSvc {
        + 解析自然语言(question) : Cypher
        + 生成分析报告(graphData) : String
        .. 需求追踪 ..
        [UC-04 智能查询]
    }

    class "生命周期服务 (LifecycleService)" as LifeSvc {
        + 注册设备(metaData)
        + 灰度升级固件(version, deviceIds)
        + 退役设备(deviceId)
        .. 需求追踪 ..
        [UC-01, UC-06, UC-07]
    }

    class "指令控制服务 (ControlService)" as ControlSvc {
        + 下发指令(deviceId, command)
        + 批量重启(deviceIds)
        .. 需求追踪 ..
        [UC-05 远程指令]
    }
}

' ==========================================
' 3. Infrastructure Layer (基础设施层 - 接口定义)
' ==========================================
package "基础设施接口 (Infrastructure Interfaces)" {

    interface "图数据库仓库 (GraphRepository)" as GraphRepo {
        + executeCypher(query)
        + mergeNode(label, props)
        + deleteRelationship(from, to)
        .. 需求追踪 ..
        [UC-02, UC-04, UC-07]
    }

    interface "大模型客户端 (LLMClient)" as LLMClient {
        + chatCompletion(prompt)
        .. 需求追踪 ..
        [UC-04 智能查询]
    }

    interface "IoT连接器 (IoTConnector)" as IoTConn {
        + sendMqttMessage(topic, payload)
        + revokeCertificate(certId)
        .. 需求追踪 ..
        [UC-01, UC-05, UC-07]
    }
}

' ==========================================
' 跨层依赖关系 (Dependency)
' ==========================================

' 服务层依赖领域实体 (使用)
TopologySvc ..> Space : 维护
TopologySvc ..> Device : 维护
LifeSvc ..> Device : 管理
LifeSvc ..> Firmware : 发布
AgentSvc ..> Device : 查询

' 服务层依赖基础设施接口 (调用)
TopologySvc ..> GraphRepo : 存取图谱
AgentSvc ..> GraphRepo : 查询图谱
AgentSvc ..> LLMClient : 语义分析
LifeSvc ..> IoTConn : 设备交互
ControlSvc ..> IoTConn : 指令下发

@enduml
```

### 关键点解读

1.  **实体关系（Domain Layer）**：
    *   **Space (组合) Space**：体现了 `Space` 是一个树状结构（楼宇 -> 楼层 -> 房间）。用了实心菱形，因为如果“A栋”被删除了，里面的“301室”也就没有存在的意义了。
    *   **Gateway (关联) Sensor**：体现了物理连接拓扑。
    *   **Space (聚合) Device**：用了空心菱形。因为设备是可以移动的，如果把“301室”删了，里面的“传感器”并不会消失，只是变成了“未分配位置”的状态。

2.  **服务职责（Application Layer）**：
    *   **TopologyService**：专门干 UC-02（构建拓扑）的事，它需要同时操作 `Device` 和 `Space` 两个实体。
    *   **AgentService**：对应 UC-04，它是一个编排者，左手调 LLM 翻译意图，右手调 GraphRepo 查库。

3.  **依赖倒置（Infrastructure Layer）**：
    *   服务层只依赖 `Interface`（如 GraphRepository），而不依赖具体的 `Neo4jDriver` 类。这在类图中表现为服务层通过虚线依赖接口。

4.  **需求追踪**：
    *   我在每个类里加了分割线 `.. 需求追踪 ..`，清晰地列出了该类是为了实现哪个 UC 而存在的。例如 `Device` 类几乎参与了所有 UC，而 `Firmware` 类只服务于 UC-06。