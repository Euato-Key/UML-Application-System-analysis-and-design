### 1. UC-02 构建拓扑关系 (Maintain Graph Topology)

此图展示了设备注册后，如何通过业务逻辑校验，最终在图数据库中通过 `MERGE` 语句建立节点与边的过程。

```plantuml
@startuml
title UC-02 构建拓扑关系流程图
skinparam ActivityBackgroundColor #FEFECE
skinparam ActivityBorderColor #B22222
skinparam ArrowColor #B22222

|#E6F2FF|用户 (运维工程师)|
|#F2FFE6|IoT交互平台 (业务逻辑)|
|#FFF2E6|知识图谱引擎 (Neo4j)|

start

|用户 (运维工程师)|
:选中待配置的新接入设备;
note left
    前置条件：
    设备已通过UC-01完成
    双向证书认证并在线
end note

|IoT交互平台 (业务逻辑)|
:加载当前空间树与可用网关;
:解析MQTT元数据(辅助推荐);

|用户 (运维工程师)|
:指定物理空间 (楼宇/房间);
:指定上行网关连接;

|IoT交互平台 (业务逻辑)|
:校验拓扑逻辑有效性;
note right
    **业务规则：**
    1. 网关必须在同一楼宇内
    2. 网关下挂设备数不能超限
end note

if (校验通过?) then (否)
    |IoT交互平台 (业务逻辑)|
    :返回错误提示;
    stop
else (是)
    |IoT交互平台 (业务逻辑)|
    :生成Cypher构建语句;
    note right
        例如:
        MATCH (r:Room {id: 'R101'})
        MATCH (d:Device {id: 'D001'})
        MERGE (d)-[:LOCATED_IN]->(r)
    end note
    
    |知识图谱引擎 (Neo4j)|
    :执行事务;
    :创建设备节点 (Node);
    :建立关联关系 (Relationship);
    
    |IoT交互平台 (业务逻辑)|
    :更新前端拓扑画布;
endif

|用户 (运维工程师)|
:查看并确认拓扑生效;

stop
@enduml
```

---

### 2. UC-04 智能查询图谱 (Intelligent QA Diagnosis)

此图重点体现了 **大模型（Agent）** 作为中间层，将非结构化的自然语言（NL）转化为结构化的图查询语言（Cypher），并处理查询结果的闭环。

```plantuml
@startuml
title UC-04 智能查询图谱流程图
skinparam ActivityBackgroundColor #E6E6FA
skinparam ActivityBorderColor #4B0082
skinparam ArrowColor #4B0082

|#E6F2FF|用户 (运营经理)|
|#F2FFE6|IoT交互平台 (LLM Agent)|
|#FFF2E6|知识图谱引擎 (Neo4j)|

start

|用户 (运营经理)|
:输入自然语言问题;
note left
    示例：
    "A栋所有温度异常的传感器
    是不是空调坏了？"
end note

|IoT交互平台 (LLM Agent)|
:大模型解析意图与实体;
note right
    识别实体：A栋, 传感器, 空调
    识别意图：关联分析, 状态查询
end note

if (意图清晰?) then (否)
    :生成澄清反问;
    |用户 (运营经理)|
    :补充上下文信息;
    stop
else (是)
    |IoT交互平台 (LLM Agent)|
    :**Text2Cypher 转换**;
    :生成图数据库查询语句;
endif

|知识图谱引擎 (Neo4j)|
:执行 Cypher 查询;
note right
    MATCH (s:Sensor)-[:LOCATED_IN]->(r:Room)
    WHERE s.temp > 30
    MATCH (ac:AC)-[:COOLS]->(r)
    RETURN s, r, ac
end note

if (查询成功?) then (否/语法错误)
    |IoT交互平台 (LLM Agent)|
    :捕获错误并尝试简化查询;
    :返回友好提示;
    stop
else (是)
    |知识图谱引擎 (Neo4j)|
    :返回子图数据 (JSON);
endif

|IoT交互平台 (LLM Agent)|
:基于数据生成自然语言总结;
:渲染受影响的设备拓扑图;

|用户 (运营经理)|
:阅读报告并查看可视化图谱;

stop
@enduml
```

---

### 3. UC-07 退役报废设备 (Decommission Device)

此图展示了严格的退役顺序：**先擦除物理数据，再清理逻辑关系**。这是物联网安全管理的关键路径。

```plantuml
@startuml
title UC-07 退役报废设备流程图
skinparam ActivityBackgroundColor #FFE6E6
skinparam ActivityBorderColor #8B0000
skinparam ArrowColor #8B0000

|#E6F2FF|用户 (运维工程师)|
|#F2FFE6|IoT交互平台 (业务逻辑)|
|#FFF2E6|知识图谱引擎 (Neo4j)|

start

|用户 (运维工程师)|
:发起设备退役请求;

|IoT交互平台 (业务逻辑)|
:检查设备在线状态;

if (设备在线?) then (是)
    :下发“安全擦除”指令;
    note right
        **安全规则：**
        必须覆盖写0操作，
        清除人脸特征/视频缓存
    end note
    :等待设备ACK确认;
else (否)
    :提示无法连接;
    |用户 (运维工程师)|
    if (确认强制退役?) then (否)
        stop
    else (是)
        |IoT交互平台 (业务逻辑)|
        :标记为“高风险遗失”;
        :记录安全审计日志;
    endif
endif

|IoT交互平台 (业务逻辑)|
:吊销设备访问证书 (Revoke Cert);

|IoT交互平台 (业务逻辑)|
:请求清理图谱数据;

|知识图谱引擎 (Neo4j)|
:执行清理事务;
fork
    :DELETE 关联关系 (Edges);
    note right
        断开 LOCATED_IN
        断开 CONNECTED_TO
        防止产生僵尸路径
    end note
fork again
    :SET 状态 = 'RETIRED';
    note right
        节点保留用于
        历史数据追溯
    end note
end fork

|IoT交互平台 (业务逻辑)|
:归档生命周期数据;
:通知退役完成;

|用户 (运维工程师)|
:安排物理拆除;

stop
@enduml
```

### 绘图要点总结（Review）：

1.  **泳道划分**：三个用例均严格遵循了 `User` -> `Platform` -> `Graph Engine` 的分层架构。
2.  **UC-02 逻辑**：清晰展示了从用户输入参数到图数据库执行 `MERGE` 语句创建节点和关系的过程。
3.  **UC-04 逻辑**：体现了 AI Agent 的核心价值——将 NL（自然语言） 翻译为 Cypher，并将结构化结果翻译回 NL。
4.  **UC-07 逻辑**：使用了 `fork` 并行处理图谱清理操作，并使用了 `if/else` 处理在线/离线两种不同的擦除流程，体现了业务的严谨性。
5.  **业务备注**：所有关键步骤（如Cypher示例、安全规则）都通过 `note` 进行了标注。